import type { NextPage, GetServerSidePropsContext } from "next";
import axios from "axios";
import { Container, Table } from "react-bootstrap";

import Head from "next/head";
import styles from "../styles/Home.module.css";

import { City, CityWithWeatherForecast } from "../types";
import { Row, Header } from "../components";

const amountOfCities = 15;

interface HomeProps {
  citiesWithWeatherForecast: CityWithWeatherForecast[];
}

const Home: NextPage<HomeProps> = (props) => {
  return (
    <Container fluid="lg">
      <Head>
        <title>Været i Norges {amountOfCities} mest befolkede byer!</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        <p>
          Denne siden viser været akkurat nå i Norges 15 mest befolkede byer.
        </p>

        <Table striped bordered hover>
          <Header />
          <tbody>
            {props.citiesWithWeatherForecast.map((city) => (
              <Row key={city.city} city={city} />
            ))}
          </tbody>
        </Table>
      </main>
    </Container>
  );
};

export default Home;

export async function getServerSideProps(context: GetServerSidePropsContext) {
  const topFiveMostPopulousCities: City[] = require("./cities.json").slice(
    0,
    amountOfCities
  );

  const citiesWithWeatherForecast: CityWithWeatherForecast[] =
    await Promise.all(
      topFiveMostPopulousCities.map(async (city) => {
        const weatherForecast = await axios.get(
          `https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${city.lat}&lon=${city.lng}`
        );
        return { ...city, weatherForecast: weatherForecast.data };
      })
    );

  return {
    props: {
      citiesWithWeatherForecast,
    },
  };
}
